<!DOCTYPE html>
<html lang="bn">

<head>
  <meta charset="UTF-8" />
  <title>üî• ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü (Admin Panel)</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 1rem;
      background: #f9fafb;
      color: #111;
    }

    h2 {
      color: #059669;
      margin-bottom: 1rem;
    }

    input,
    select {
      padding: 8px;
      margin: 0.2rem 0.5rem 0.8rem 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      width: 180px;
    }

    button {
      cursor: pointer;
      background: #10b981;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      margin-left: 5px;
      transition: background 0.3s;
    }

    button:hover {
      background: #059669;
    }

    ul {
      list-style: none;
      padding-left: 0;
    }

    li {
      background: white;
      padding: 8px 12px;
      margin-bottom: 6px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    }

    li > div {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    img {
      max-width: 50px;
      border-radius: 4px;
      object-fit: cover;
    }

    .edit-input {
      padding: 5px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 120px;
    }

    .logout-btn {
      background: #ef4444;
      margin-bottom: 1rem;
    }

    .logout-btn:hover {
      background: #b91c1c;
    }
  </style>
</head>

<body>
  <h2>üî• Admin Panel - Category, Subcategory & Product Management</h2>
  <button class="logout-btn" onclick="logout()">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>

  <hr>

  <h3>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
  <input type="text" id="categoryName" placeholder="‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ" />
  <button onclick="addCategory()">‚ûï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>

  <h3>‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
  <select id="selectCategoryForSubcat">
    <option value="">-- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
  </select><br>
  <input type="text" id="subCategoryName" placeholder="‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ" />
  <button onclick="addSubCategory()">‚ûï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>

  <h3>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
  <select id="selectCategoryForProduct">
    <option value="">-- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
  </select>
  <select id="selectSubCategoryForProduct">
    <option value="">-- ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
  </select><br>
  <input type="text" id="productName" placeholder="‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ" />
  <input type="text" id="productPrice" placeholder="‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" />
  <input type="text" id="productImage" placeholder="‡¶á‡¶Æ‡ßá‡¶ú URL" />
  <button onclick="addProduct()">‚ûï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>

  <hr>

  <h3>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∏‡¶Æ‡ßÇ‡¶π</h3>
  <ul id="categoryList"></ul>

  <script type="module">
    import {
      auth,
      onAuthStateChanged,
      signOut,
      db,
      collection,
      addDoc,
      deleteDoc,
      doc,
      getDocs,
      updateDoc,
      query,
      where,
      orderBy
    } from './firebase.js';

    // Refs for collections
    const categoriesRef = collection(db, "categories");
    const subcategoriesRef = collection(db, "subcategories");
    const productsRef = collection(db, "products");

    // Authentication check
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html"; // Redirect if not logged in
      } else {
        loadCategories();
        populateCategorySelectors();
      }
    });

    // Logout
    window.logout = async function () {
      await signOut(auth);
      window.location.href = "login.html";
    };

    // Add Category
    window.addCategory = async function () {
      const name = document.getElementById("categoryName").value.trim();
      if (!name) return alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
      await addDoc(categoriesRef, { name });
      document.getElementById("categoryName").value = "";
      await loadCategories();
      await populateCategorySelectors();
    };

    // Add Subcategory
    window.addSubCategory = async function () {
      const name = document.getElementById("subCategoryName").value.trim();
      const categoryId = document.getElementById("selectCategoryForSubcat").value;
      if (!categoryId) return alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
      if (!name) return alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
      await addDoc(subcategoriesRef, { name, categoryId });
      document.getElementById("subCategoryName").value = "";
      await loadCategories();
    };

    // Add Product
    window.addProduct = async function () {
      const name = document.getElementById("productName").value.trim();
      const price = document.getElementById("productPrice").value.trim();
      const img = document.getElementById("productImage").value.trim();
      const categoryId = document.getElementById("selectCategoryForProduct").value;
      const subCategoryId = document.getElementById("selectSubCategoryForProduct").value;

      if (!categoryId) return alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
      if (!subCategoryId) return alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
      if (!name) return alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
      if (!price) return alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");

      await addDoc(productsRef, { name, price, img, categoryId, subCategoryId });
      document.getElementById("productName").value = "";
      document.getElementById("productPrice").value = "";
      document.getElementById("productImage").value = "";
      await loadCategories();
    };

    // Load categories, subcategories & products in list view
    async function loadCategories() {
      const categoryList = document.getElementById("categoryList");
      categoryList.innerHTML = "";

      const categoriesSnapshot = await getDocs(categoriesRef);
      for (const catDoc of categoriesSnapshot.docs) {
        const catData = catDoc.data();

        // Create li for category
        const li = document.createElement("li");

        // Editable category name
        const categoryNameInput = document.createElement("input");
        categoryNameInput.value = catData.name;
        categoryNameInput.classList.add("edit-input");
        categoryNameInput.onchange = async () => {
          await updateDoc(doc(db, "categories", catDoc.id), { name: categoryNameInput.value });
          await loadCategories();
          await populateCategorySelectors();
        };

        // Delete category button
        const deleteCatBtn = document.createElement("button");
        deleteCatBtn.textContent = "‚ùå ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®";
        deleteCatBtn.style.background = "#ef4444";
        deleteCatBtn.onclick = async () => {
          // ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßã ‡¶Ü‡¶ó‡ßá (cascade delete)
          await deleteSubcategoriesByCategory(catDoc.id);
          await deleteProductsByCategory(catDoc.id);
          await deleteDoc(doc(db, "categories", catDoc.id));
          await loadCategories();
          await populateCategorySelectors();
        };

        // Load subcategories for this category
        const subcatUl = document.createElement("ul");
        subcatUl.style.marginLeft = "1.5rem";

        const subcatQuery = query(subcategoriesRef, where("categoryId", "==", catDoc.id), orderBy("name"));
        const subcatSnapshot = await getDocs(subcatQuery);

        for (const subcatDoc of subcatSnapshot.docs) {
          const subcatData = subcatDoc.data();

          const subcatLi = document.createElement("li");

          // Editable subcategory name
          const subcatNameInput = document.createElement("input");
          subcatNameInput.value = subcatData.name;
          subcatNameInput.classList.add("edit-input");
          subcatNameInput.onchange = async () => {
            await updateDoc(doc(db, "subcategories", subcatDoc.id), { name: subcatNameInput.value });
            await loadCategories();
          };

          // Delete subcategory button
          const deleteSubcatBtn = document.createElement("button");
          deleteSubcatBtn.textContent = "‚ùå ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®";
          deleteSubcatBtn.style.background = "#dc2626";
          deleteSubcatBtn.onclick = async () => {
            await deleteProductsBySubcategory(subcatDoc.id);
            await deleteDoc(doc(db, "subcategories", subcatDoc.id));
            await loadCategories();
          };

          // Load products for this subcategory
          const prodUl = document.createElement("ul");
          prodUl.style.marginLeft = "1.5rem";

          const prodQuery = query(productsRef, where("subCategoryId", "==", subcatDoc.id), orderBy("name"));
          const prodSnapshot = await getDocs(prodQuery);

          for (const prodDoc of prodSnapshot.docs) {
            const prodData = prodDoc.data();

            const prodLi = document.createElement("li");

            // Editable product fields
            const prodNameInput = document.createElement("input");
            prodNameInput.value = prodData.name;
            prodNameInput.classList.add("edit-input");

            const prodPriceInput = document.createElement("input");
            prodPriceInput.value = prodData.price;
            prodPriceInput.classList.add("edit-input");
            prodPriceInput.style.width = "70px";

            const prodImgInput = document.createElement("input");
            prodImgInput.value = prodData.img;
            prodImgInput.classList.add("edit-input");
            prodImgInput.style.width = "150px";

            // Update on change
            prodNameInput.onchange = prodPriceInput.onchange = prodImgInput.onchange = async () => {
              await updateDoc(doc(db, "products", prodDoc.id), {
                name: prodNameInput.value,
                price: prodPriceInput.value,
                img: prodImgInput.value
              });
              await loadCategories();
            };

            // Delete product button
            const deleteProdBtn = document.createElement("button");
            deleteProdBtn.textContent = "‚ùå ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®";
            deleteProdBtn.style.background = "#b91c1c";
            deleteProdBtn.onclick = async () => {
              await deleteDoc(doc(db, "products", prodDoc.id));
              await loadCategories();
            };

            // Product display div
            const prodDiv = document.createElement("div");
            prodDiv.appendChild(prodNameInput);
            prodDiv.appendChild(prodPriceInput);
            prodDiv.appendChild(prodImgInput);
            prodDiv.appendChild(deleteProdBtn);

            prodLi.appendChild(prodDiv);
            prodUl.appendChild(prodLi);
          }

          subcatLi.appendChild(subcatNameInput);
          subcatLi.appendChild(deleteSubcatBtn);
          subcatLi.appendChild(prodUl);
          subcatUl.appendChild(subcatLi);
        }

        li.appendChild(categoryNameInput);
        li.appendChild(deleteCatBtn);
        li.appendChild(subcatUl);
        categoryList.appendChild(li);
      }
    }

    // Delete cascade functions
    async function deleteSubcategoriesByCategory(categoryId) {
      const subcatQuery = query(subcategoriesRef, where("categoryId", "==", categoryId));
      const subcats = await getDocs(subcatQuery);
      for (const subcatDoc of subcats.docs) {
        await deleteProductsBySubcategory(subcatDoc.id);
        await deleteDoc(doc(db, "subcategories", subcatDoc.id));
      }
    }

    async function deleteProductsByCategory(categoryId) {
      const prodQuery = query(productsRef, where("categoryId", "==", categoryId));
      const prods = await getDocs(prodQuery);
      for (const prodDoc of prods.docs) {
        await deleteDoc(doc(db, "products", prodDoc.id));
      }
    }

    async function deleteProductsBySubcategory(subCategoryId) {
      const prodQuery = query(productsRef, where("subCategoryId", "==", subCategoryId));
      const prods = await getDocs(prodQuery);
      for (const prodDoc of prods.docs) {
        await deleteDoc(doc(db, "products", prodDoc.id));
      }
    }

    // Populate category selectors for subcategory and product inputs
    async function populateCategorySelectors() {
      const selectSubcat = document.getElementById("selectCategoryForSubcat");
      const selectProdCat = document.getElementById("selectCategoryForProduct");
      selectSubcat.innerHTML = `<option value="">-- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>`;
      selectProdCat.innerHTML = `<option value="">-- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>`;

      const categoriesSnapshot = await getDocs(categoriesRef);
      for (const catDoc of categoriesSnapshot.docs) {
        const option = document.createElement("option");
        option.value = catDoc.id;
        option.textContent = catDoc.data().name;

        selectSubcat.appendChild(option.cloneNode(true));
        selectProdCat.appendChild(option);
      }
      updateSubCategoryOptions();
    }

    // Update Subcategory dropdown based on selected Category (product section)
    document.getElementById("selectCategoryForProduct").addEventListener("change", updateSubCategoryOptions);

    async function updateSubCategoryOptions() {
      const categoryId = document.getElementById("selectCategoryForProduct").value;
      const selectSubCategory = document.getElementById("selectSubCategoryForProduct");
      selectSubCategory.innerHTML = `<option value="">-- ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>`;

      if (!categoryId) return;

      const subcatQuery = query(subcategoriesRef, where("categoryId", "==", categoryId), orderBy("name"));
      const subcatsSnapshot = await getDocs(subcatQuery);

      for (const subcatDoc of subcatsSnapshot.docs) {
        const option = document.createElement("option");
        option.value = subcatDoc.id;
        option.textContent = subcatDoc.data().name;
        selectSubCategory.appendChild(option);
      }
    }
  </script>
</body>

</html>
